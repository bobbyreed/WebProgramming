<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - CSCI 3403</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.png">
    <link rel="stylesheet" href="../styles/presentation.css">
    <link rel="stylesheet" href="../styles/auth.css">
    <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-secondary);
        min-height: 100vh;
        padding: 40px 20px;
    }
    
    .leaderboard-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .leaderboard-header {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px var(--shadow);
        text-align: center;
        margin-bottom: 30px;
        border: 2px solid var(--ocu-true-blue);
    }
    
    .leaderboard-header h1 {
        color: var(--ocu-true-blue);
        font-size: 3em;
        margin-bottom: 10px;
    }
    
    [data-theme="dark"] .leaderboard-header {
        border-color: var(--ocu-cyan);
    }
    
    [data-theme="dark"] .leaderboard-header h1 {
        color: var(--ocu-cyan);
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .stat-card {
        background: var(--ocu-true-blue);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        border: 2px solid var(--ocu-dark-blue);
    }
    
    [data-theme="dark"] .stat-card {
        background: var(--ocu-dark-blue);
        border-color: var(--ocu-cyan);
    }
    
    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
    }
    
    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
    
    .podium-container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 40px;
        align-items: end;
    }
    
    .podium-place {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 10px 30px var(--shadow);
        transition: transform 0.3s ease;
        border: 3px solid;
    }
    
    .podium-place:hover {
        transform: translateY(-10px);
    }
    
    .place-1 {
        grid-column: 2;
        grid-row: 1;
        background: #FFF8DC;
        border-color: #FFD700;
        color: #333;
        transform: scale(1.1);
    }
    
    .place-2 {
        grid-column: 1;
        grid-row: 1;
        background: #F5F5F5;
        border-color: #C0C0C0;
        color: #333;
    }
    
    .place-3 {
        grid-column: 3;
        grid-row: 1;
        background: #FFF5EE;
        border-color: #CD7F32;
        color: #333;
    }
    
    [data-theme="dark"] .place-1 {
        background: rgba(255, 215, 0, 0.1);
        color: #FFD700;
    }
    
    [data-theme="dark"] .place-2 {
        background: rgba(192, 192, 192, 0.1);
        color: #C0C0C0;
    }
    
    [data-theme="dark"] .place-3 {
        background: rgba(205, 127, 50, 0.1);
        color: #CD7F32;
    }
    
    .trophy {
        font-size: 3em;
        margin-bottom: 10px;
    }
    
    .student-name {
        font-size: 1.4em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .points-display {
        font-size: 2em;
        font-weight: bold;
    }
    
    .points-label {
        font-size: 0.9em;
        opacity: 0.8;
    }
    
    .full-leaderboard {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px var(--shadow);
        border: 2px solid var(--ocu-light-blue);
    }
    
    [data-theme="dark"] .full-leaderboard {
        border-color: var(--ocu-dark-blue);
    }
    
    .leaderboard-table {
        width: 100%;
    }
    
    .leaderboard-row {
        display: grid;
        grid-template-columns: 60px 1fr 150px 100px;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: var(--bg-secondary);
        border-radius: 10px;
        transition: all 0.3s ease;
        border: 1px solid var(--ocu-light-blue);
    }
    
    [data-theme="dark"] .leaderboard-row {
        border-color: var(--ocu-dark-blue);
    }
    
    .leaderboard-row:hover {
        transform: translateX(10px);
        box-shadow: 0 5px 15px var(--shadow);
        border-color: var(--ocu-true-blue);
    }
    
    [data-theme="dark"] .leaderboard-row:hover {
        border-color: var(--ocu-cyan);
    }
    
    .rank {
        font-size: 1.5em;
        font-weight: bold;
        color: var(--ocu-true-blue);
    }
    
    [data-theme="dark"] .rank {
        color: var(--ocu-cyan);
    }
    
    .student-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--ocu-true-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        border: 2px solid var(--ocu-dark-blue);
    }
    
    [data-theme="dark"] .avatar {
        background: var(--ocu-dark-blue);
        border-color: var(--ocu-cyan);
    }
    
    .badges {
        display: flex;
        gap: 5px;
    }
    
    .badge {
        font-size: 1.5em;
    }
    
    .current-user {
        background: var(--ocu-light-green);
        border: 3px solid var(--ocu-green);
    }
    
    [data-theme="dark"] .current-user {
        background: rgba(112, 191, 84, 0.1);
        border-color: var(--ocu-green);
    }
    
    .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: var(--card-bg);
        color: var(--ocu-true-blue);
        padding: 10px 20px;
        border-radius: 25px;
        text-decoration: none;
        box-shadow: 0 4px 10px var(--shadow);
        transition: all 0.3s ease;
        border: 2px solid var(--ocu-true-blue);
        font-weight: bold;
    }
    
    [data-theme="dark"] .back-button {
        color: var(--ocu-cyan);
        border-color: var(--ocu-cyan);
    }
    
    .back-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px var(--shadow);
        background: var(--ocu-true-blue);
        color: white;
    }
    
    [data-theme="dark"] .back-button:hover {
        background: var(--ocu-cyan);
        color: var(--ocu-dark-blue);
    }
    
    .achievement-showcase {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .achievement {
        background: var(--bg-secondary);
        padding: 10px 20px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 2px solid var(--ocu-light-blue);
    }
    
    [data-theme="dark"] .achievement {
        border-color: var(--ocu-dark-blue);
    }
    
    .achievement-icon {
        font-size: 1.5em;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .leaderboard-row {
        animation: slideIn 0.5s ease forwards;
        opacity: 0;
    }
    
    .leaderboard-row:nth-child(1) { animation-delay: 0.1s; }
    .leaderboard-row:nth-child(2) { animation-delay: 0.2s; }
    .leaderboard-row:nth-child(3) { animation-delay: 0.3s; }
    .leaderboard-row:nth-child(4) { animation-delay: 0.4s; }
    .leaderboard-row:nth-child(5) { animation-delay: 0.5s; }
</style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <span class="theme-toggle-label">Light</span>
        <label class="theme-switch">
            <input type="checkbox" id="theme-checkbox">
            <span class="theme-slider"></span>
        </label>
        <span class="theme-toggle-label">Dark</span>
    </div>
    
    <a href="../index.html" class="back-button">‚Üê Back to Course</a>
    
    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h1>üèÜ Class Leaderboard</h1>
            <p style="font-size: 1.3em; color: var(--text-secondary);">CSCI 3403 - Spring 2025</p>
            
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value" id="total-students">0</div>
                    <div class="stat-label">Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-points">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-points">0</div>
                    <div class="stat-label">Average</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="your-rank">-</div>
                    <div class="stat-label">Your Rank</div>
                </div>
            </div>
        </div>
        
        <!-- Top 3 Podium -->
        <div class="podium-container" id="podium">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <!-- Full Leaderboard -->
        <div class="full-leaderboard">
            <h2 style="margin-bottom: 20px; color: var(--text-primary);">Full Rankings</h2>
            <div id="leaderboard-list">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Achievements Section -->
        <div class="full-leaderboard" style="margin-top: 30px;">
            <h2 style="margin-bottom: 20px; color: var(--text-primary);">üéñÔ∏è Recent Achievements</h2>
            <div class="achievement-showcase" id="achievements">
                <div class="achievement">
                    <span class="achievement-icon">üåü</span>
                    <span>First Login Champion</span>
                </div>
                <div class="achievement">
                    <span class="achievement-icon">üìö</span>
                    <span>Lecture Completionist</span>
                </div>
                <div class="achievement">
                    <span class="achievement-icon">üî•</span>
                    <span>3-Day Streak</span>
                </div>
            </div>
        </div>
    </div>
<script src="../js/auth.js"></script>
<script>
    // Real Leaderboard Data Fetching - NO TOKEN NEEDED FOR PUBLIC READS!
    const MASTER_GIST_ID = '0d1ed1373d1b88183b2e94542bbbad1f';
    const API_BASE = 'https://api.github.com/gists';
    
    async function fetchRealLeaderboard() {
        try {
            // Show loading state
            document.getElementById('leaderboard-list').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 2em;">üîÑ</div>
                    <div>Loading leaderboard data...</div>
                </div>
            `;
            
            // Fetch master config - NO AUTH NEEDED for public gists!
            const masterResponse = await fetch(`${API_BASE}/${MASTER_GIST_ID}`);
            
            if (!masterResponse.ok) {
                throw new Error(`Failed to fetch config: ${masterResponse.status}`);
            }
            
            const masterGist = await masterResponse.json();
            
            if (!masterGist.files || !masterGist.files['csci3403-config.json']) {
                throw new Error('Config file not found');
            }
            
            const config = JSON.parse(masterGist.files['csci3403-config.json'].content);
            
            if (!config.students || Object.keys(config.students).length === 0) {
                console.log('No students enrolled yet');
                return [];
            }
            
            // Fetch all student data in parallel - NO AUTH NEEDED for public reads!
            const studentPromises = Object.entries(config.students).map(async ([studentId, gistId]) => {
                try {
                    const response = await fetch(`${API_BASE}/${gistId}`);
                    
                    if (!response.ok) {
                        console.warn(`Skipping ${studentId}: Gist not found (${response.status})`);
                        return null; // Return null instead of throwing
                    }
                    
                    const gist = await response.json();
                    
                    if (!gist.files || !gist.files['student-data.json']) {
                        console.warn(`Skipping ${studentId}: No data file`);
                        return null;
                    }
                    
                    const data = JSON.parse(gist.files['student-data.json'].content);
                    
                    // Calculate engagement score for secondary sorting
                    const engagementScore = calculateEngagement(data);
                    
                    return {
                        id: studentId,
                        name: data.name || studentId,
                        points: data.points || 0,
                        badges: data.achievements || [],
                        streak: data.streak || 0,
                        lastActive: data.lastActive,
                        viewedLectures: Object.keys(data.viewedLectures || {}).length,
                        activities: data.activities || [],
                        engagementScore: engagementScore,
                        joinedDate: data.joinedDate
                    };
                } catch (error) {
                    console.warn(`Error processing ${studentId}:`, error.message);
                    return null; // Return null for any errors
    }
            });
            
            const students = await Promise.all(studentPromises);
            
            // Sort by points (primary) and engagement (secondary)
            students.sort((a, b) => {
                if (b.points === a.points) {
                    return b.engagementScore - a.engagementScore;
                }
                return b.points - a.points;
            });
            
            return students;
            
        } catch (error) {
            console.error('Error fetching leaderboard:', error);
            document.getElementById('leaderboard-list').innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--error-color);">
                    <div style="font-size: 2em;">‚ö†Ô∏è</div>
                    <div>Error loading leaderboard: ${error.message}</div>
                    <button onclick="location.reload()" style="
                        margin-top: 20px;
                        padding: 10px 20px;
                        background: var(--ocu-true-blue);
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                    ">Retry</button>
                </div>
            `;
            return [];
        }
    }
    
    function calculateEngagement(data) {
        let score = 0;
        
        // Points for activities
        score += (data.activities?.length || 0) * 2;
        
        // Points for viewed lectures
        score += Object.keys(data.viewedLectures || {}).length * 5;
        
        // Points for streak
        score += (data.streak || 0) * 3;
        
        // Bonus for recent activity (within 24 hours)
        if (data.lastActive) {
            const lastActive = new Date(data.lastActive);
            const now = new Date();
            const hoursSinceActive = (now - lastActive) / (1000 * 60 * 60);
            if (hoursSinceActive < 24) {
                score += 10;
            }
        }
        
        return score;
    }
    
    function getActivitySummary(student) {
        if (!student.lastActive) {
            return 'üÜï New student';
        }
        
        // Generate a fun status message based on their activity
        const hoursSinceActive = (new Date() - new Date(student.lastActive)) / (1000 * 60 * 60);
        
        if (hoursSinceActive < 1) {
            return 'üü¢ Active now';
        } else if (hoursSinceActive < 24) {
            return 'üî• ' + student.streak + ' day streak';
        } else if (hoursSinceActive < 48) {
            return 'üìö ' + student.viewedLectures + ' lectures viewed';
        } else {
            return 'üí§ Last seen ' + Math.floor(hoursSinceActive / 24) + ' days ago';
        }
    }
    
    function formatBadges(badges) {
        // Map achievement codes to emojis if needed
        const badgeMap = {
            'üÜï': { icon: 'üÜï', title: 'New Student' },
            'early_bird': { icon: 'üåÖ', title: 'Early Bird' },
            'night_owl': { icon: 'ü¶â', title: 'Night Owl' },
            'streak_3': { icon: 'üî•', title: '3 Day Streak' },
            'streak_7': { icon: 'üí•', title: 'Week Streak' },
            'perfect_week': { icon: '‚≠ê', title: 'Perfect Week' },
            'helper': { icon: 'ü§ù', title: 'Helpful Classmate' },
            'speed_reader': { icon: '‚ö°', title: 'Speed Reader' }
        };
        
        return badges.map(badge => {
            const badgeInfo = badgeMap[badge] || { icon: badge, title: '' };
            return `<span class="badge" title="${badgeInfo.title}">${badgeInfo.icon}</span>`;
        }).join('');
    }
    
    function getCurrentUser() {
        const authData = localStorage.getItem('csci3403_auth');
        return authData ? JSON.parse(authData).studentId : null;
    }
    
    function populatePodium(students) {
        const podium = document.getElementById('podium');
        const top3 = students.slice(0, 3);
        
        podium.innerHTML = '';
        
        if (top3.length === 0) {
            podium.innerHTML = '<div style="text-align: center; grid-column: 1/-1;">No students yet!</div>';
            return;
        }
        
        // Create podium places (reordered for visual layout)
        const order = [1, 0, 2]; // Silver, Gold, Bronze
        const classes = ['place-2', 'place-1', 'place-3'];
        const trophies = ['ü•à', 'ü•á', 'ü•â'];
        
        order.forEach((index, visualIndex) => {
            if (top3[index]) {
                const student = top3[index];
                const div = document.createElement('div');
                div.className = `podium-place ${classes[visualIndex]}`;
                div.innerHTML = `
                    <div class="trophy">${trophies[visualIndex]}</div>
                    <div class="student-name">${student.name}</div>
                    <div class="points-display">${student.points}</div>
                    <div class="points-label">points</div>
                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                        ${getActivitySummary(student)}
                    </div>
                `;
                podium.appendChild(div);
            }
        });
    }
    
    function populateLeaderboard(students) {
        const list = document.getElementById('leaderboard-list');
        const currentUser = getCurrentUser();
        
        if (students.length === 0) {
            list.innerHTML = '<div style="text-align: center; padding: 20px;">No students enrolled yet!</div>';
            return;
        }
        
        let html = '';
        
        students.forEach((student, index) => {
            const isCurrentUser = student.id === currentUser;
            
            // Special styling for top 3
            let rankStyle = '';
            if (index === 0) rankStyle = 'color: #FFD700;'; // Gold
            else if (index === 1) rankStyle = 'color: #C0C0C0;'; // Silver
            else if (index === 2) rankStyle = 'color: #CD7F32;'; // Bronze
            
            html += `
                <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}">
                    <div class="rank" style="${rankStyle}">#${index + 1}</div>
                    <div class="student-info">
                        <div class="avatar">${student.name[0].toUpperCase()}</div>
                        <div>
                            <div style="font-weight: bold;">
                                ${student.name} ${isCurrentUser ? '(You)' : ''}
                            </div>
                            <div style="font-size: 0.9em; opacity: 0.7;">
                                ${getActivitySummary(student)}
                            </div>
                        </div>
                    </div>
                    <div class="badges">
                        ${formatBadges(student.badges)}
                    </div>
                    <div style="text-align: right; font-weight: bold; font-size: 1.2em;">
                        ${student.points} pts
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
        
        // Update stats
        updateStatistics(students, currentUser);
    }
    
    function updateStatistics(students, currentUser) {
        // Total students
        document.getElementById('total-students').textContent = students.length;
        
        // Total points
        const totalPoints = students.reduce((sum, s) => sum + s.points, 0);
        document.getElementById('total-points').textContent = totalPoints;
        
        // Average points
        const avgPoints = students.length > 0 ? Math.round(totalPoints / students.length) : 0;
        document.getElementById('avg-points').textContent = avgPoints;
        
        // Your rank
        const userIndex = students.findIndex(s => s.id === currentUser);
        document.getElementById('your-rank').textContent = userIndex >= 0 ? `#${userIndex + 1}` : '-';
        
        // Update stat card colors based on performance
        if (userIndex >= 0) {
            const rankCard = document.querySelector('#your-rank').parentElement;
            
            if (userIndex === 0) {
                rankCard.style.background = '#FFD700';
                rankCard.style.color = '#333';
            } else if (userIndex === 1) {
                rankCard.style.background = '#C0C0C0';
                rankCard.style.color = '#333';
            } else if (userIndex === 2) {
                rankCard.style.background = '#CD7F32';
                rankCard.style.color = 'white';
            }
        }
    }
    
    // Auto-refresh function
    let refreshInterval;
    function startAutoRefresh() {
        // Refresh every 30 seconds
        refreshInterval = setInterval(async () => {
            console.log('Auto-refreshing leaderboard...');
            const students = await fetchRealLeaderboard();
            if (students.length > 0) {
                populatePodium(students);
                populateLeaderboard(students);
            }
        }, 30000);
    }
    
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        // Check if user is authenticated
        const authData = localStorage.getItem('csci3403_auth');
        if (!authData) {
            alert('Please login to view the leaderboard');
            window.location.href = '../index.html';
            return;
        }
        
        // Fetch and display real data
        const students = await fetchRealLeaderboard();
        if (students.length > 0) {
            populatePodium(students);
            populateLeaderboard(students);
        }
        
        // Start auto-refresh
        startAutoRefresh();
        
        // Stop refresh when page is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
        
        // Theme toggle
        const currentTheme = localStorage.getItem('ocuTheme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        document.getElementById('theme-checkbox').checked = currentTheme === 'dark';
        
        document.getElementById('theme-checkbox').addEventListener('change', function() {
            const theme = this.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('ocuTheme', theme);
        });
    });
    
    // Add manual refresh button
    document.addEventListener('DOMContentLoaded', () => {
        const header = document.querySelector('.leaderboard-header');
        const refreshBtn = document.createElement('button');
        refreshBtn.innerHTML = 'üîÑ Refresh';
        refreshBtn.style.cssText = `
            background: var(--ocu-true-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1em;
            transition: all 0.3s ease;
        `;
        refreshBtn.onclick = async () => {
            refreshBtn.innerHTML = '‚è≥ Refreshing...';
            const students = await fetchRealLeaderboard();
            if (students.length > 0) {
                populatePodium(students);
                populateLeaderboard(students);
            }
            refreshBtn.innerHTML = 'üîÑ Refresh';
        };
        header.appendChild(refreshBtn);
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        if (window.authManager) {
            window.authManager.trackSocialActivity('view_leaderboard');
        }
    });
</script>
</body>
</html>