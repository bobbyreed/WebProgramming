<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSCI 3403 - Leaderboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Oklahoma City University Colors */
            --ocu-blue: #002868;
            --ocu-gold: #FFD700;
            --ocu-light-blue: #4A90E2;
            --ocu-gray: #F5F5F5;
            
            /* Dark Theme Colors */
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #ffffff;
            --text-secondary: #b8b8b8;
            --accent: #e94560;
            --success: #00d25b;
            --warning: #ffab00;
            --gradient-start: #667eea;
            --gradient-end: #764ba2;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }
        
        /* Background animations */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23667eea" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,154.7C960,171,1056,181,1152,165.3C1248,149,1344,107,1392,85.3L1440,64L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path></svg>') no-repeat;
            background-size: cover;
            pointer-events: none;
            z-index: 1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }
        
        header {
            text-align: center;
            padding: 40px 0;
            background: rgba(15, 52, 96, 0.8);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 3em;
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 1.2em;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* Podium */
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 50px 0;
            min-height: 300px;
        }
        
        .podium-place {
            background: rgba(15, 52, 96, 0.9);
            border-radius: 15px 15px 0 0;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .podium-place.first {
            height: 250px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .podium-place.second {
            height: 200px;
            background: linear-gradient(135deg, #C0C0C0, #808080);
            color: #333;
        }
        
        .podium-place.third {
            height: 150px;
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: #fff;
        }
        
        .podium-rank {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .podium-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .podium-points {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        /* Leaderboard List */
        .full-leaderboard {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .leaderboard-rank {
            font-size: 1.5em;
            font-weight: bold;
            width: 50px;
            color: var(--gradient-start);
        }
        
        .leaderboard-info {
            flex: 1;
            margin-left: 20px;
        }
        
        .leaderboard-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .leaderboard-stats {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .leaderboard-points {
            font-size: 1.3em;
            font-weight: bold;
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        
        .error {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* Rate Limit Warning */
        .rate-limit-warning {
            background: rgba(255, 171, 0, 0.2);
            border: 1px solid var(--warning);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* Achievement Showcase */
        .achievement-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .achievement {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .achievement:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .achievement-icon {
            font-size: 2em;
        }
        
        .achievement-info {
            flex: 1;
        }
        
        .achievement-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .achievement-student {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .achievement-time {
            color: var(--text-secondary);
            font-size: 0.8em;
        }
        
        /* Current User Highlight */
        .leaderboard-item.current-user {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid var(--gradient-start);
        }
        
        /* Back Button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(15, 52, 96, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-button">← Back to Dashboard</a>
    
    <div class="container">
        <header>
            <h1>🏆 Leaderboard</h1>
            <p class="subtitle">CSCI 3403 - Web Programming</p>
            
            <!-- Stats Overview -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="total-students">0</div>
                    <div class="stat-label">Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-points">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-points">0</div>
                    <div class="stat-label">Average</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="your-rank">-</div>
                    <div class="stat-label">Your Rank</div>
                </div>
            </div>
        </header>
        
        <!-- Top 3 Podium -->
        <div class="podium-container" id="podium">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <!-- Full Leaderboard -->
        <div class="full-leaderboard">
            <h2 style="margin-bottom: 20px; color: var(--text-primary);">Full Rankings</h2>
            <div id="leaderboard-list">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Achievements Section -->
        <div class="full-leaderboard" style="margin-top: 30px;">
            <h2 style="margin-bottom: 20px; color: var(--text-primary);">🎖️ Recent Achievements</h2>
            <div class="achievement-showcase" id="achievements">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <script src="../js/auth.js"></script>
    <script>
        // Use the authenticated Netlify function instead of direct GitHub API calls
        const FUNCTION_URL = '/.netlify/functions/get-all-students';
        
        async function fetchLeaderboard() {
            try {
                // Show loading state
                document.getElementById('leaderboard-list').innerHTML = `
                    <div class="loading">
                        <div style="font-size: 2em;">🔄</div>
                        <div>Loading leaderboard data...</div>
                    </div>
                `;
                
                // Fetch all student data through authenticated function
                console.log('Fetching leaderboard data from authenticated endpoint...');
                const response = await fetch(FUNCTION_URL);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load data');
                }
                
                console.log(`Loaded ${Object.keys(data.students).length} students`);
                
                // Show rate limit info if available
                if (data.rateLimit) {
                    console.log(`GitHub API Rate Limit: ${data.rateLimit.remaining}/${data.rateLimit.limit}`);
                    if (data.rateLimit.remaining < 100) {
                        showRateLimitWarning(data.rateLimit);
                    }
                }
                
                // Process and display the data
                displayLeaderboard(data.students);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('leaderboard-list').innerHTML = `
                    <div class="error">
                        <h3>⚠️ Error Loading Leaderboard</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px;">Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

       function displayLeaderboard(students) {
            // Convert to array and handle both 'points' and 'totalPoints' field names
            const leaderboardData = Object.entries(students)
                .map(([id, data]) => {
                    // IMPORTANT: Check for both 'points' and 'totalPoints' field names
                    let actualPoints = data.totalPoints || data.points || 0;
                    
                    // If both are missing or 0, try to calculate from activities
                    if (actualPoints === 0 && data.viewedLectures) {
                        // Each lecture is worth 10 points based on your auth.js
                        const lectureCount = Object.keys(data.viewedLectures).length;
                        actualPoints = lectureCount * 10;
                        
                        // Add achievement points if they exist
                        if (data.achievements && Array.isArray(data.achievements)) {
                            // Count achievements (excluding the welcome emoji)
                            const achievementCount = data.achievements.filter(a => a !== '🆕').length;
                            // Rough estimate: 25 points per achievement average
                            actualPoints += achievementCount * 25;
                        }
                    }
                    
                    return {
                        studentId: id,
                        ...data,
                        totalPoints: actualPoints, // Use the corrected points value
                        achievements: data.achievements || [],
                        lecturesViewed: data.lecturesViewed || [],
                        viewedLectures: data.viewedLectures || {},
                        activities: data.activities || []
                    };
                })
                .filter(student => student.studentId) // Remove any invalid entries
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            // Update stats
            const totalStudents = leaderboardData.length;
            const totalPoints = leaderboardData.reduce((sum, s) => sum + s.totalPoints, 0);
            const avgPoints = totalStudents > 0 ? Math.round(totalPoints / totalStudents) : 0;
            
            document.getElementById('total-students').textContent = totalStudents;
            document.getElementById('total-points').textContent = totalPoints.toLocaleString();
            document.getElementById('avg-points').textContent = avgPoints;
            
            // Check if current user is in the leaderboard
            const currentUser = localStorage.getItem('csci3403_auth');
            if (currentUser) {
                const authData = JSON.parse(currentUser);
                const userRank = leaderboardData.findIndex(s => s.studentId === authData.studentId) + 1;
                document.getElementById('your-rank').textContent = userRank > 0 ? `#${userRank}` : '-';
            }
            
            // Display podium (top 3)
            displayPodium(leaderboardData.slice(0, 3));
            
            // Display full leaderboard
            const leaderboardHTML = leaderboardData.map((student, index) => {
                const rank = index + 1;
                const isCurrentUser = currentUser && JSON.parse(currentUser).studentId === student.studentId;
                
                // Count actual lectures viewed (from viewedLectures object)
                const lectureCount = Object.keys(student.viewedLectures || {}).length;
                
                return `
                    <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                        <div class="leaderboard-rank">#${rank}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">
                                ${student.studentId} ${rank <= 3 ? getRankEmoji(rank) : ''}
                                ${isCurrentUser ? '(You)' : ''}
                            </div>
                            <div class="leaderboard-stats">
                                Achievements: ${student.achievements.length} | 
                                Lectures: ${lectureCount} | 
                                Points: ${student.totalPoints}
                            </div>
                        </div>
                        <div class="leaderboard-points">${student.totalPoints} pts</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('leaderboard-list').innerHTML = leaderboardHTML || '<div class="loading">No students enrolled yet</div>';
            
            // Display recent achievements
            displayRecentAchievements(leaderboardData);
        }
                // Helper function to get achievement definitions
                function getAchievementDefinition(achievementId) {
                    const ACHIEVEMENT_DEFINITIONS = {
                        'first_steps': { points: 10 },
                        'quick_learner': { points: 25 },
                        'dedicated_student': { points: 50 },
                        'knowledge_seeker': { points: 100 },
                        'course_master': { points: 500 },
                        'consistent': { points: 30 },
                        'week_warrior': { points: 75 },
                        'unstoppable': { points: 150 },
                        'legendary_streak': { points: 500 },
                        'early_bird': { points: 25 },
                        'night_owl': { points: 25 },
                        'weekend_warrior': { points: 30 },
                        'speed_demon': { points: 50 }
                    };
                    
                    return ACHIEVEMENT_DEFINITIONS[achievementId] || { points: 0 };
                }
        
        function displayRecentAchievements(students) {
            // Collect all achievements with timestamps
            const allAchievements = [];
            
            students.forEach(student => {
                if (student.achievements && Array.isArray(student.achievements)) {
                    student.achievements.forEach(achievement => {
                        if (achievement.unlockedAt) {
                            allAchievements.push({
                                ...achievement,
                                studentId: student.studentId,
                                timestamp: new Date(achievement.unlockedAt)
                            });
                        }
                    });
                }
            });
            
            // Sort by most recent and take top 6
            allAchievements.sort((a, b) => b.timestamp - a.timestamp);
            const recentAchievements = allAchievements.slice(0, 6);
            
            if (recentAchievements.length === 0) {
                document.getElementById('achievements').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">
                        No achievements unlocked yet
                    </div>
                `;
                return;
            }
            
            const achievementsHTML = recentAchievements.map(achievement => {
                const timeAgo = getTimeAgo(achievement.timestamp);
                return `
                    <div class="achievement">
                        <span class="achievement-icon">${achievement.icon || '🏆'}</span>
                        <div class="achievement-info">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-student">${achievement.studentId}</div>
                            <div class="achievement-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('achievements').innerHTML = achievementsHTML;
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + " years ago";
            if (interval === 1) return "1 year ago";
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + " months ago";
            if (interval === 1) return "1 month ago";
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + " days ago";
            if (interval === 1) return "1 day ago";
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + " hours ago";
            if (interval === 1) return "1 hour ago";
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + " minutes ago";
            if (interval === 1) return "1 minute ago";
            
            return "Just now";
        }
        
        function displayPodium(topThree) {
            if (topThree.length === 0) {
                document.getElementById('podium').innerHTML = '<div class="loading">No data available</div>';
                return;
            }
            
            const podiumHTML = `
                ${topThree[1] ? `
                    <div class="podium-place second">
                        <div class="podium-rank">🥈</div>
                        <div class="podium-name">${topThree[1].studentId}</div>
                        <div class="podium-points">${topThree[1].totalPoints} pts</div>
                    </div>
                ` : ''}
                ${topThree[0] ? `
                    <div class="podium-place first">
                        <div class="podium-rank">🥇</div>
                        <div class="podium-name">${topThree[0].studentId}</div>
                        <div class="podium-points">${topThree[0].totalPoints} pts</div>
                    </div>
                ` : ''}
                ${topThree[2] ? `
                    <div class="podium-place third">
                        <div class="podium-rank">🥉</div>
                        <div class="podium-name">${topThree[2].studentId}</div>
                        <div class="podium-points">${topThree[2].totalPoints} pts</div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('podium').innerHTML = podiumHTML;
        }
        
        function getRankEmoji(rank) {
            switch(rank) {
                case 1: return '🥇';
                case 2: return '🥈';
                case 3: return '🥉';
                default: return '';
            }
        }
        
        function showRateLimitWarning(rateLimit) {
            const resetTime = new Date(rateLimit.reset).toLocaleTimeString();
            const warning = document.createElement('div');
            warning.className = 'rate-limit-warning';
            warning.innerHTML = `
                <strong>⚡ Rate Limit Warning</strong><br>
                Only ${rateLimit.remaining} of ${rateLimit.limit} API requests remaining.<br>
                Resets at ${resetTime}
            `;
            document.querySelector('header').appendChild(warning);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchLeaderboard();
            
            // Refresh every 60 seconds
            setInterval(fetchLeaderboard, 60000);
        });
    </script>
</body>
</html>