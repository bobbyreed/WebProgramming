<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - CSCI 3403</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --ocu-cyan: #00ffff;
            --ocu-magenta: #ff00ff;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --warning-border: #ffc107;
            --danger-border: #ff5252;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .admin-header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 2px solid var(--ocu-cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-title {
            font-size: 2em;
            color: var(--ocu-cyan);
            text-shadow: 2px 2px 4px rgba(0, 255, 255, 0.3);
        }
        
        .admin-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }
        
        .card-title {
            font-size: 1.5em;
            color: var(--ocu-cyan);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .student-item {
            background: var(--bg-primary);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .student-item:hover {
            border-color: var(--ocu-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        .student-info {
            flex: 1;
        }
        
        .student-name {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .student-meta {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .student-actions {
            display: flex;
            gap: 10px;
        }
        
        button {
            background: var(--bg-primary);
            color: var(--ocu-cyan);
            border: 1px solid var(--ocu-cyan);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        button:hover {
            background: var(--ocu-cyan);
            color: var(--bg-primary);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        .btn-view {
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }
        
        .btn-view:hover {
            background: var(--text-secondary);
            color: var(--bg-primary);
        }
        
        .btn-points {
            border-color: var(--success);
            color: var(--success);
        }
        
        .btn-points:hover {
            background: var(--success);
            color: var(--bg-primary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 2em;
            color: var(--ocu-cyan);
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .control-panel {
            margin-top: 30px;
        }
        
        .control-btn {
            display: inline-block;
            margin: 5px;
            padding: 12px 20px;
            background: var(--bg-primary);
            color: var(--ocu-cyan);
            border: 2px solid var(--ocu-cyan);
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: var(--ocu-cyan);
            color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4);
        }
        
        .control-btn.danger {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .control-btn.danger:hover {
            background: var(--danger);
            color: white;
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
        }
        
        .control-btn.add-points {
            border-color: var(--success);
            color: var(--success);
        }
        
        .control-btn.add-points:hover {
            background: var(--success);
            color: white;
        }
        
        .activity-feed {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 10px;
            margin-bottom: 10px;
            background: var(--bg-primary);
            border-radius: 5px;
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 0.9em;
        }
        
        .activity-time {
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        
        .activity-message {
            color: var(--text-primary);
            flex: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .rate-limit-bar {
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--ocu-cyan);
            font-size: 0.95em;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: var(--ocu-cyan);
        }
        
        .modal-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: var(--bg-primary);
            border: 1px solid var(--ocu-cyan);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1em;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .cleanup-results {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 10px;
        }
        
        .cleanup-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .cleanup-stat {
            text-align: center;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        
        .cleanup-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--ocu-cyan);
        }
        
        .cleanup-stat-label {
            font-size: 0.9em;
            color: var(--text-muted);
        }
        
        .removed-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .removed-item {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 0, 0, 0.1);
            border-left: 3px solid var(--danger-border);
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .spinner {
            border: 3px solid var(--bg-secondary);
            border-top: 3px solid var(--ocu-cyan);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 1.2em;
            color: var(--ocu-cyan);
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <h1 class="admin-title">üéì Admin Panel - CSCI 3403</h1>
        <div class="admin-controls">
            <span id="rateLimitStatus" style="margin-right: 20px; color: var(--ocu-cyan);"></span>
            <span id="admin-name">Prof. Reed</span>
            <button class="control-btn" onclick="adminManager.logout()">Logout</button>
        </div>
    </header>
    
    <div class="container">
        <div class="dashboard-grid">
            <!-- Students Panel -->
            <div class="card">
                <h2 class="card-title">
                    <span>üë•</span> Students
                </h2>
                <div class="student-list" id="studentList">
                    <!-- Students will be loaded here -->
                </div>
            </div>
            
            <!-- Control Panel -->
            <div class="main-panel">
                <!-- Rate Limit Info -->
                <div class="card" style="background: rgba(255, 193, 7, 0.1); border: 1px solid var(--warning-border);">
                    <h3 style="color: var(--warning-border); margin-bottom: 10px;">‚ö° API Rate Limits</h3>
                    <p style="font-size: 0.9em; line-height: 1.5;">
                        GitHub limits unauthenticated requests to <strong>60 per hour</strong>. Authenticated requests get <strong>5000 per hour</strong>. 
                        Loading all students or running cleanup uses many requests.
                    </p>
                </div>
                
                <!-- Statistics -->
                <div class="card">
                    <h2 class="card-title">
                        <span>üìä</span> Statistics
                    </h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalPoints">0</div>
                            <div class="stat-label">Total Points</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgPoints">0</div>
                            <div class="stat-label">Average Points</div>
                        </div>
                    </div>
                    
                    <!-- Control Buttons -->
                    <div class="control-panel">
                        <h3 style="margin-bottom: 15px; color: var(--ocu-cyan);">üéÆ Admin Controls</h3>
                        <div>
                            <button class="control-btn" onclick="adminManager.refreshData()">
                                üîÑ Refresh Data
                            </button>
                            <button class="control-btn" onclick="adminManager.cleanupGists()">
                                üßπ Cleanup Invalid Gists
                            </button>
                            <button class="control-btn danger" onclick="adminManager.resetAll()">
                                ‚ö†Ô∏è Reset All Points
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Feed -->
                <div class="card">
                    <h2 class="card-title">
                        <span>üìù</span> Recent Activity
                    </h2>
                    <div class="activity-feed" id="activityFeed">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Points Modal -->
    <div class="modal" id="pointsModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Add Points</h3>
            <input type="hidden" id="modalStudentId">
            <input type="number" class="modal-input" id="pointsInput" 
                   placeholder="Enter points amount...">
            <input type="text" class="modal-input" id="reasonInput" 
                   placeholder="Reason (optional)...">
            <div class="modal-buttons">
                <button class="control-btn" onclick="closeModal()">Cancel</button>
                <button class="control-btn add-points" onclick="confirmPoints()">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Cleanup Results Modal -->
    <div class="modal" id="cleanupModal">
        <div class="modal-content">
            <h3 class="modal-title">üßπ Cleanup Results</h3>
            <div class="cleanup-results">
                <div class="cleanup-stats">
                    <div class="cleanup-stat">
                        <div class="cleanup-stat-value" id="cleanupChecked">0</div>
                        <div class="cleanup-stat-label">Checked</div>
                    </div>
                    <div class="cleanup-stat">
                        <div class="cleanup-stat-value" id="cleanupRemoved">0</div>
                        <div class="cleanup-stat-label">Removed</div>
                    </div>
                    <div class="cleanup-stat">
                        <div class="cleanup-stat-value" id="cleanupRemaining">0</div>
                        <div class="cleanup-stat-label">Remaining</div>
                    </div>
                </div>
                <div id="cleanupMessage"></div>
                <div class="removed-list" id="removedList"></div>
            </div>
            <div class="modal-buttons">
                <button class="control-btn" onclick="closeCleanupModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Processing...</div>
    </div>
    
    <script>
        // Fixed Admin Panel Gist Integration with Cleanup
        class AdminGistManager {
            constructor() {
                // Netlify function endpoints (for ALL operations)
                this.FUNCTION_URL = '/.netlify/functions/update-points';
                this.GET_ALL_URL = '/.netlify/functions/get-all-students';
                this.ADMIN_AUTH_URL = '/.netlify/functions/admin-auth';  // Admin auth endpoint
                
                // Master gist ID (only used for reference)
                this.MASTER_GIST_ID = '0d1ed1373d1b88183b2e94542bbbad1f';
                
                // Data storage
                this.masterConfig = null;
                this.students = new Map();
                this.isAdmin = false;
                
                // Activity log
                this.activityLog = [];
                
                // Initialize
                this.init();
            }
            
            async init() {
                // Check admin authentication
                const adminAuth = localStorage.getItem('csci3403_admin');
                const sessionToken = localStorage.getItem('csci3403_admin_session');
                
                // Make sure to check if it exists AND has a truthy value
                if (adminAuth && adminAuth === 'true' && sessionToken) {
                    this.isAdmin = true;
                    await this.updateRateLimitStatus();
                    await this.loadAllData();
                    
                    // Update rate limit status every 30 seconds
                    setInterval(() => this.updateRateLimitStatus(), 30000);
                } else {
                    // No valid admin auth found, show login modal
                    this.showLoginModal();
                }
            }
            
            // Use Netlify function for secure authentication
            async showLoginModal() {
                const password = prompt('Enter admin password:');
                
                if (!password) {
                    alert('Authentication cancelled.');
                    window.location.href = '../index.html';
                    return;
                }
                
                try {
                    // Show loading state
                    this.showLoadingOverlay('Authenticating...');
                    
                    // Call the Netlify function to verify password
                    const response = await fetch(this.ADMIN_AUTH_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            password: password
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success && result.authenticated) {
                        // Authentication successful
                        localStorage.setItem('csci3403_admin', 'true');
                        localStorage.setItem('csci3403_admin_session', result.sessionToken);
                        this.isAdmin = true;
                        
                        // Hide loading and reinitialize
                        this.hideLoadingOverlay();
                        
                        // Reinitialize after successful authentication
                        await this.updateRateLimitStatus();
                        await this.loadAllData();
                        
                        // Set up periodic updates
                        setInterval(() => this.updateRateLimitStatus(), 30000);
                        
                        this.addActivity('‚úÖ Admin authenticated successfully');
                        
                    } else {
                        // Authentication failed
                        this.hideLoadingOverlay();
                        alert(result.error || 'Invalid admin credentials. Access denied.');
                        
                        // Clear any existing auth data
                        localStorage.removeItem('csci3403_admin');
                        localStorage.removeItem('csci3403_admin_session');
                        
                        // Redirect to home page
                        window.location.href = '../index.html';
                    }
                    
                } catch (error) {
                    console.error('Authentication error:', error);
                    this.hideLoadingOverlay();
                    alert('Authentication failed. Please check your connection and try again.');
                    
                    // Clear auth data and redirect
                    localStorage.removeItem('csci3403_admin');
                    localStorage.removeItem('csci3403_admin_session');
                    window.location.href = '../index.html';
                }
            }
            
            async loadAllData() {
                this.showLoadingOverlay('Loading all student data...');
                
                try {
                    // Use authenticated endpoint to get all data in one request
                    console.log('Fetching all data from authenticated endpoint...');
                    const response = await fetch(this.GET_ALL_URL);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch data: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load data');
                    }
                    
                    // Store config
                    this.masterConfig = data.config;
                    
                    // Store students
                    this.students.clear();
                    Object.entries(data.students).forEach(([id, studentData]) => {
                        this.students.set(id, studentData);
                    });
                    
                    console.log(`Loaded ${this.students.size} students`);
                    
                    // Update rate limit display
                    if (data.rateLimit) {
                        this.displayRateLimit(data.rateLimit);
                    }
                    
                    // Display the data
                    this.displayStudents();
                    this.updateDashboard();
                    this.addActivity('‚úÖ Loaded all student data');
                    
                    // Handle any errors that occurred
                    if (data.errors && data.errors.length > 0) {
                        console.warn('Some students had errors:', data.errors);
                        this.addActivity(`‚ö†Ô∏è ${data.errors.length} students had errors loading`);
                    }
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError('Failed to load data: ' + error.message);
                    this.addActivity('‚ùå Failed to load data');
                } finally {
                    this.hideLoadingOverlay();
                }
            }
            
            async updateRateLimitStatus() {
                // This is now included in the get-all-students response
                // No need for separate rate limit check
                if (this.isAdmin) {
                    await this.loadAllData();
                }
            }
            
            displayRateLimit(rateLimit) {
                const limitElement = document.getElementById('rateLimitStatus');
                if (limitElement) {
                    const percentage = (rateLimit.remaining / rateLimit.limit * 100).toFixed(0);
                    const resetTime = new Date(rateLimit.reset).toLocaleTimeString();
                    
                    limitElement.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>API Requests</span>
                                    <span>${rateLimit.remaining} / ${rateLimit.limit}</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; overflow: hidden;">
                                    <div style="background: ${percentage > 20 ? 'var(--success)' : 'var(--warning)'}; 
                                                width: ${percentage}%; height: 100%; transition: width 0.3s;"></div>
                                </div>
                                <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 5px;">
                                    Resets at ${resetTime}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            displayStudents() {
                const studentList = document.getElementById('studentList');
                if (!studentList) return;
                
                if (this.students.size === 0) {
                    studentList.innerHTML = '<div class="empty-state">No students enrolled</div>';
                    return;
                }
                
                // Sort students by points
                const sortedStudents = Array.from(this.students.entries())
                    .sort((a, b) => (b[1].totalPoints || 0) - (a[1].totalPoints || 0));
                
                studentList.innerHTML = sortedStudents.map(([id, data]) => `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${id}</div>
                            <div class="student-meta">
                                Points: ${data.totalPoints || 0} | 
                                Lectures: ${data.lecturesViewed ? data.lecturesViewed.length : 0}
                            </div>
                        </div>
                        <div class="student-actions">
                            <button onclick="adminManager.viewStudent('${id}')" class="btn-view">View</button>
                            <button onclick="adminManager.addPointsToStudent('${id}')" class="btn-points">+Points</button>
                        </div>
                    </div>
                `).join('');
            }
            
            updateDashboard() {
                // Update statistics
                const totalStudents = this.students.size;
                const totalPoints = Array.from(this.students.values())
                    .reduce((sum, s) => sum + (s.totalPoints || 0), 0);
                const avgPoints = totalStudents > 0 ? Math.round(totalPoints / totalStudents) : 0;
                
                const totalStudentsEl = document.getElementById('totalStudents');
                const totalPointsEl = document.getElementById('totalPoints');
                const avgPointsEl = document.getElementById('avgPoints');
                
                if (totalStudentsEl) totalStudentsEl.textContent = totalStudents;
                if (totalPointsEl) totalPointsEl.textContent = totalPoints;
                if (avgPointsEl) avgPointsEl.textContent = avgPoints;
            }
            
            async addPointsToStudent(studentId) {
                const student = this.students.get(studentId);
                if (!student) return;
                
                const pointsToAdd = prompt(`Add points to ${studentId}:\nCurrent points: ${student.totalPoints || 0}`, '10');
                if (!pointsToAdd || isNaN(pointsToAdd)) return;
                
                const points = parseInt(pointsToAdd);
                
                this.showLoadingOverlay(`Adding ${points} points to ${studentId}...`);
                
                try {
                    // Update student data
                    student.totalPoints = (student.totalPoints || 0) + points;
                    student.lastModified = new Date().toISOString();
                    
                    // Use the update-points function with authentication
                    const response = await fetch(this.FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'updateStudent',
                            studentId: studentId,
                            gistId: student.gistId,
                            updateData: student
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to update student');
                    }
                    
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Update failed');
                    }
                    
                    this.addActivity(`‚úÖ Added ${points} points to ${studentId}`);
                    await this.loadAllData(); // Refresh all data
                    
                } catch (error) {
                    console.error('Error adding points:', error);
                    this.showError('Failed to add points: ' + error.message);
                    // Revert the local change
                    student.totalPoints = (student.totalPoints || 0) - points;
                } finally {
                    this.hideLoadingOverlay();
                }
            }
            
            async cleanupGists() {
                if (!confirm('This will check all student gist IDs and remove invalid entries.\n\nThis uses authenticated requests through Netlify. Continue?')) {
                    return;
                }
                
                this.showLoadingOverlay('Running cleanup operation...');
                
                try {
                    // Use the cleanup action through authenticated function
                    const response = await fetch(this.FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'cleanup',
                            masterGistId: this.MASTER_GIST_ID
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Cleanup request failed: ${response.status} - ${errorText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Cleanup failed');
                    }
                    
                    // Display cleanup results
                    this.showCleanupResults(result);
                    
                    // Reload data after cleanup
                    await this.loadAllData();
                    
                } catch (error) {
                    console.error('Cleanup error:', error);
                    this.showError('Cleanup failed: ' + error.message);
                } finally {
                    this.hideLoadingOverlay();
                }
            }
            
            showCleanupResults(result) {
                const modal = document.getElementById('cleanupModal');
                
                // FIX: Use correct element IDs
                const checkedEl = document.getElementById('cleanupChecked');
                const removedEl = document.getElementById('cleanupRemoved');
                const remainingEl = document.getElementById('cleanupRemaining');
                
                if (checkedEl) checkedEl.textContent = result.totalChecked || 0;
                if (removedEl) removedEl.textContent = result.totalRemoved || 0;
                if (remainingEl) remainingEl.textContent = result.totalRemaining || 0;
                
                const message = document.getElementById('cleanupMessage');
                if (message) message.textContent = result.message || 'Cleanup completed';
                
                const removedList = document.getElementById('removedList');
                if (removedList) {
                    if (result.removedStudents && result.removedStudents.length > 0) {
                        removedList.innerHTML = '<h4>Removed Students:</h4>' +
                            result.removedStudents.map(s => `<div class="removed-item">‚Ä¢ ${s}</div>`).join('');
                    } else {
                        removedList.innerHTML = '<div>No invalid entries found</div>';
                    }
                }
                
                // Use class-based display for consistency
                modal.classList.add('active');
                this.addActivity(`üßπ Cleanup: Removed ${result.totalRemoved || 0} invalid entries`);
            }
            
            // FIX #2: Add missing resetAll method
            async resetAll() {
                if (!confirm('‚ö†Ô∏è WARNING: This will reset ALL student points to 0!\n\nAre you ABSOLUTELY sure?')) {
                    return;
                }
                
                // Double confirmation for destructive action
                const confirmText = prompt('This action cannot be undone. Type "RESET" to confirm:');
                if (confirmText !== 'RESET') {
                    alert('Reset cancelled');
                    return;
                }
                
                this.showLoadingOverlay('Resetting all points...');
                
                try {
                    let successCount = 0;
                    let failCount = 0;
                    
                    // Reset all students in memory
                    for (const [studentId, student] of this.students) {
                        try {
                            student.totalPoints = 0;
                            student.lastModified = new Date().toISOString();
                            
                            // Update via API
                            const response = await fetch(this.FUNCTION_URL, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    action: 'updateStudent',
                                    studentId: studentId,
                                    gistId: student.gistId,
                                    updateData: student
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error(`Failed to reset ${studentId}`);
                            }
                            
                            successCount++;
                        } catch (error) {
                            console.error(`Failed to reset ${studentId}:`, error);
                            failCount++;
                        }
                    }
                    
                    this.addActivity(`‚ö†Ô∏è Reset points: ${successCount} success, ${failCount} failed`);
                    await this.loadAllData();
                    
                    if (failCount > 0) {
                        alert(`Reset complete with errors:\n${successCount} students reset\n${failCount} students failed`);
                    } else {
                        alert(`Successfully reset all ${successCount} student points to 0`);
                    }
                    
                } catch (error) {
                    console.error('Reset error:', error);
                    this.showError('Failed to reset points: ' + error.message);
                } finally {
                    this.hideLoadingOverlay();
                }
            }
            
            viewStudent(studentId) {
                const student = this.students.get(studentId);
                if (!student) return;
                
                const details = `
                    Student: ${studentId}
                    Total Points: ${student.totalPoints || 0}
                    Lectures Viewed: ${student.lecturesViewed ? student.lecturesViewed.length : 0}
                    Achievements: ${student.achievements ? student.achievements.length : 0}
                    Last Login: ${student.lastLogin || 'Never'}
                    Last Modified: ${student.lastModified || 'Never'}
                    Gist ID: ${student.gistId || 'Not set'}
                `;
                
                alert(details);
            }
            
            async refreshData() {
                this.addActivity('üîÑ Refreshing data...');
                await this.loadAllData();
            }
            
            addActivity(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.activityLog.unshift({ message, timestamp });
                
                // Keep only last 10 activities
                if (this.activityLog.length > 10) {
                    this.activityLog.pop();
                }
                
                this.displayActivityLog();
            }
            
            // FIX: Use correct element ID
            displayActivityLog() {
                const logElement = document.getElementById('activityFeed');
                if (!logElement) return;
                
                logElement.innerHTML = this.activityLog.map(entry => `
                    <div class="activity-item">
                        <span class="activity-time">${entry.timestamp}</span>
                        <span class="activity-message">${entry.message}</span>
                    </div>
                `).join('');
            }
            
            showLoadingOverlay(message = 'Processing...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                if (overlay && text) {
                    text.textContent = message;
                    overlay.style.display = 'flex';
                }
            }
            
            hideLoadingOverlay() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
            
            showError(message) {
                alert('Error: ' + message);
                this.addActivity('‚ùå Error: ' + message);
            }
            
            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    // Clear admin authentication
                    localStorage.removeItem('csci3403_admin');
                    localStorage.removeItem('csci3403_admin_session');  // Clear session token
                    
                    // Clear any other admin-related data
                    localStorage.removeItem('admin_session');
                    
                    // Force redirect to home page
                    window.location.replace('../index.html');
                }
            }
        }
        
        // Helper functions - these should be outside the class
        function closeModal() {
            document.getElementById('pointsModal').classList.remove('active');
            document.getElementById('pointsInput').value = '';
            document.getElementById('reasonInput').value = '';
        }
        
        function closeCleanupModal() {
            document.getElementById('cleanupModal').classList.remove('active');
        }
        
        async function confirmPoints() {
            const studentId = document.getElementById('modalStudentId').value;
            const points = parseInt(document.getElementById('pointsInput').value);
            const reason = document.getElementById('reasonInput').value;
            
            if (!points || points === 0) {
                alert('Please enter a valid points value');
                return;
            }
            
            // Implementation for updating points
            const action = points > 0 ? 'Added' : 'Removed';
            adminManager.addActivity(`${action} ${Math.abs(points)} points for ${studentId}: ${reason || 'No reason'}`);
            
            closeModal();
        }
        
        // Initialize admin manager
        const adminManager = new AdminGistManager();
    </script>
</body>
</html>